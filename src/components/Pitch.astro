---
import { presentationData, colorMap } from "../data/presentation";

const { pitch } = presentationData;

// Narrative subtitles for each journey step
const narratives = [
  "The foundation of who I am",
  "The moments that shaped me",
  "Where I create the most impact",
  "My path of continuous growth",
  "The compass that guides my decisions",
];

// Icons for each category
const icons = [
  "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z", // Character - person
  "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", // Experiences - clock
  "M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z", // Strengths - badge
  "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6", // Growth - trending up
  "M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z", // Values - heart
];
---

<!-- Progress Indicator (right side) -->
<div id="pitch-progress" class="fixed right-6 top-1/2 -translate-y-1/2 z-50 hidden lg:flex flex-col gap-3">
  {pitch.map((category, index) => (
    <button
      class="progress-dot group relative w-3 h-3 rounded-full bg-[var(--ctp-surface2)] transition-all duration-300 hover:bg-[var(--ctp-overlay0)]"
      data-index={index}
      aria-label={`Go to ${category.title}`}
    >
      <span
        class="absolute right-6 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap text-sm text-[var(--color-text-muted)] bg-[var(--color-surface)] px-2 py-1 rounded"
      >
        {category.title}
      </span>
    </button>
  ))}
</div>

<!-- Fixed Scroll Arrow (bottom center) - always visible during pitch sections -->
<a
  id="pitch-scroll-arrow"
  href="#pitch-0"
  class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 hidden text-[var(--ctp-overlay0)] hover:text-[var(--ctp-mauve)] transition-all duration-300 hover:scale-110"
  aria-label="Scroll to next section"
>
  <svg class="w-8 h-8 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
  </svg>
</a>

<!-- Fixed arrow for Pitch Header -->
<a
  id="pitch-header-arrow"
  href="#pitch-0"
  class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 hidden text-[var(--ctp-overlay0)] hover:text-[var(--ctp-mauve)] transition-all duration-300 hover:scale-110"
  aria-label="Start the journey"
>
  <svg class="w-8 h-8 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
  </svg>
</a>

<!-- Section Header (Full Screen) -->
<section id="pitch" class="min-h-[calc(100dvh-4rem)] flex items-center justify-center px-4 scroll-mt-16">
  <div class="max-w-4xl mx-auto text-center">
    <p class="fade-in font-mono text-sm text-[var(--ctp-mauve)] uppercase tracking-widest mb-4">
      Part One
    </p>
    <h3 class="fade-in text-4xl sm:text-5xl lg:text-6xl font-bold text-[var(--color-text)] mb-6">
      5 x 5 Pitch
    </h3>
    <p class="fade-in text-lg text-[var(--color-text-muted)] max-w-2xl mx-auto">
      Five dimensions that define who I am â€” scroll to explore each one
    </p>
  </div>
</section>

<!-- Journey Sections -->
{pitch.map((category, index) => (
  <section
    class="pitch-section min-h-[calc(100dvh-4rem)] flex items-center px-4 py-12 lg:py-16 relative scroll-mt-16"
    data-index={index}
    id={`pitch-${index}`}
  >
    <!-- Background accent -->
    <div
      class="absolute inset-0 opacity-0 transition-opacity duration-1000 pointer-events-none"
      style={`background: radial-gradient(ellipse at 50% 50%, color-mix(in srgb, ${colorMap[category.color]} 8%, transparent), transparent 70%);`}
      data-bg
    />

    <!-- Main content -->
    <div class="max-w-5xl mx-auto w-full relative">
      <div class="grid lg:grid-cols-2 gap-6 lg:gap-16 items-start lg:items-center">

          <!-- Left: Title & Question -->
          <div class="pitch-content opacity-0 translate-y-8 transition-all duration-700 ease-out">
            <!-- Step indicator -->
            <div class="flex items-center gap-3 mb-3 lg:mb-4">
              <span
                class="w-9 h-9 lg:w-12 lg:h-12 rounded-lg lg:rounded-xl flex items-center justify-center text-white font-bold text-sm lg:text-lg"
                style={`background-color: ${colorMap[category.color]};`}
              >
                {index + 1}
              </span>
              <div>
                <p class="text-[10px] lg:text-xs font-mono text-[var(--ctp-overlay0)] uppercase tracking-wider">
                  Dimension {index + 1} of 5
                </p>
                <p class="text-xs lg:text-sm text-[var(--color-text-muted)] italic">
                  {narratives[index]}
                </p>
              </div>
            </div>

            <!-- Title -->
            <h3
              class="text-2xl sm:text-3xl lg:text-5xl font-bold mb-2 lg:mb-3 transition-colors"
              style={`color: ${colorMap[category.color]};`}
            >
              {category.title}
            </h3>

            <!-- Question -->
            <p class="text-base sm:text-lg lg:text-2xl text-[var(--color-text-muted)]">
              {category.question}
            </p>

            <!-- Icon (hidden on smaller screens) -->
            <div class="mt-4 hidden xl:block">
              <svg
                class="w-16 h-16 opacity-20"
                style={`color: ${colorMap[category.color]};`}
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d={icons[index]} />
              </svg>
            </div>
          </div>

          <!-- Right: Items -->
          <div class="pitch-items space-y-2 lg:space-y-3">
            {category.items.map((item, itemIndex) => (
              <div
                class="pitch-item opacity-0 translate-x-8 bg-[var(--color-surface)] rounded-lg lg:rounded-xl border border-[var(--ctp-surface1)] p-3 lg:p-4 transition-all duration-500 hover:border-current"
                style={`transition-delay: ${itemIndex * 100}ms; color: ${colorMap[category.color]};`}
              >
                <div class="flex items-start gap-2 lg:gap-3">
                  <span
                    class="mt-1.5 flex-shrink-0 w-1.5 h-1.5 lg:w-2 lg:h-2 rounded-full"
                    style={`background-color: ${colorMap[category.color]};`}
                  />
                  <div>
                    <span class="font-semibold text-sm lg:text-base text-[var(--color-text)]">{item.point}</span>
                    {item.detail && (
                      <p class="text-xs lg:text-sm text-[var(--ctp-subtext0)] mt-0.5">{item.detail}</p>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>

        </div>
      </div>
    </div>
  </section>
))}

<style>
  .pitch-section.in-view .pitch-content {
    opacity: 1;
    transform: translateY(0);
  }

  .pitch-section.in-view .pitch-item {
    opacity: 1;
    transform: translateX(0);
  }

  .pitch-section.in-view [data-bg] {
    opacity: 1;
  }

  .progress-dot.active {
    width: 0.75rem;
    height: 1.5rem;
    border-radius: 0.375rem;
  }

  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }
</style>

<script>
  function initPitchScrolling() {
    const sections = document.querySelectorAll('.pitch-section');
    const progressDots = document.querySelectorAll('.progress-dot');
    const progressContainer = document.getElementById('pitch-progress');
    const scrollArrow = document.getElementById('pitch-scroll-arrow');
    const headerArrow = document.getElementById('pitch-header-arrow');
    const pitchHeader = document.getElementById('pitch');

    if (!sections.length) return;

    // Header arrow visibility - show when pitch header is visible, hide when entering sections
    if (pitchHeader && headerArrow) {
      const headerObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              headerArrow.style.display = 'block';
            } else {
              headerArrow.style.display = 'none';
            }
          });
        },
        { threshold: 0.5 }
      );
      headerObserver.observe(pitchHeader);
    }

    let currentSectionIndex = -1;

    // Intersection Observer for sections
    const sectionObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-view');

            // Update current section index
            const index = parseInt(entry.target.getAttribute('data-index') || '0');
            currentSectionIndex = index;

            // Update progress dots
            const colors = ['var(--ctp-green)', 'var(--ctp-teal)', 'var(--ctp-mauve)', 'var(--ctp-peach)', 'var(--ctp-blue)'];
            progressDots.forEach((dot, i) => {
              dot.classList.toggle('active', i === index);
              if (i === index) {
                (dot as HTMLElement).style.backgroundColor = colors[i];
              } else {
                (dot as HTMLElement).style.backgroundColor = '';
              }
            });

            // Update scroll arrow href
            if (scrollArrow) {
              const nextIndex = index + 1;
              if (nextIndex < sections.length) {
                scrollArrow.setAttribute('href', `#pitch-${nextIndex}`);
                scrollArrow.setAttribute('aria-label', `Scroll to next dimension`);
              } else {
                scrollArrow.setAttribute('href', '#motivation');
                scrollArrow.setAttribute('aria-label', 'Continue to Motivation');
              }
            }
          }
        });
      },
      {
        threshold: 0.3,
        rootMargin: '-20% 0px -20% 0px'
      }
    );

    sections.forEach((section) => {
      sectionObserver.observe(section);
    });

    // Show/hide navigation elements based on pitch section visibility
    const lastPitchSection = sections[sections.length - 1];

    // Observer to show arrow and progress when entering pitch SECTIONS (not header)
    const showObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            if (scrollArrow) scrollArrow.style.display = 'block';
            if (progressContainer) progressContainer.style.display = 'flex';
          }
        });
      },
      { threshold: 0.3 }
    );

    // Only observe the actual pitch sections, not the header
    sections.forEach((section) => showObserver.observe(section));

    // Observer to hide when past last section
    const hideObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          // Hide when last section is no longer visible AND we've scrolled past it
          if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
            if (scrollArrow) scrollArrow.style.display = 'none';
            if (progressContainer) progressContainer.style.display = 'none';
          }
        });
      },
      { threshold: 0 }
    );

    if (lastPitchSection) hideObserver.observe(lastPitchSection);

    // Also hide when above first pitch section (scrolled back up)
    const firstPitchSection = sections[0];
    const hideAboveObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting && entry.boundingClientRect.top > 0) {
            if (scrollArrow) scrollArrow.style.display = 'none';
            if (progressContainer) progressContainer.style.display = 'none';
          }
        });
      },
      { threshold: 0 }
    );

    if (firstPitchSection) hideAboveObserver.observe(firstPitchSection);

    // Click to navigate (progress dots)
    progressDots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = dot.getAttribute('data-index');
        const targetSection = document.querySelector(`.pitch-section[data-index="${index}"]`);
        if (targetSection) {
          targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  }

  initPitchScrolling();
  document.addEventListener('astro:after-swap', initPitchScrolling);
</script>
